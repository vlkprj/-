<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–í–ê–õ–ö–ò ‚Ä¢ –ì—Ä–∞—Ñ—ñ–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --c-yellow: #fbbf24; --c-red: #d9463b; --c-dark: #060606;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--c-dark); color: #ffffff;
            margin: 0; padding: 0; -webkit-font-smoothing: antialiased; overflow-x: hidden;
        }

        /* === –•–ï–î–ï–† === */
        .sticky-header {
            position: sticky; top: 0; left: 0; width: 100%;
            background: rgba(6, 6, 6, 0.85);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            z-index: 100; padding: 15px 20px; box-sizing: border-box;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .branding { display: flex; align-items: center; gap: 8px; }
        .logo-img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background: #222; border: 1px solid #333; }
        .app-title { font-size: 20px; font-weight: 900; letter-spacing: 0.5px; margin: 0; display: flex; align-items: center; gap: 6px; }
        .app-title svg { fill: var(--c-yellow); width: 22px; height: 22px; margin-top: -2px; }
        .date-badge { background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 12px; font-weight: 800; color: var(--c-yellow); font-size: 13px; }

        .dashboard { display: flex; justify-content: space-between; align-items: flex-start; }
        .status-box { display: flex; flex-direction: column; gap: 6px; }
        .status-label { font-size: 12px; color: #888; font-weight: 700; text-transform: uppercase; }
        .status-value { display: flex; align-items: center; gap: 6px; font-size: 15px; font-weight: 800; }
        
        .timer-box { text-align: right; }
        .timer-label { font-size: 12px; color: #888; font-weight: 700; text-transform: uppercase; margin-bottom: 2px; }
        .timer-time { font-size: 34px; font-weight: 900; line-height: 1; font-variant-numeric: tabular-nums; letter-spacing: -1px; }
        .timer-time.off { color: var(--c-red); text-shadow: 0 0 15px rgba(217, 70, 59, 0.4); }
        .timer-time.on { color: var(--c-yellow); text-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }

        /* === –¢–ê–ô–ú–õ–ê–ô–ù === */
        #timelineContainer { padding: 20px; display: flex; flex-direction: column; gap: 0; min-height: 60vh; position: relative; }
        
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.05); background: rgba(255,255,255,0.02); }
            50% { box-shadow: 0 0 20px 0 rgba(255,255,255,0.08); background: rgba(255,255,255,0.06); }
            100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); background: rgba(255,255,255,0.02); }
        }
        @keyframes breath { 0% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 0.8; } }

        .tl-item { display: flex; flex-direction: column; z-index: 2; position: relative; padding: 10px 0; transition: 0.3s ease; border-radius: 16px; margin-bottom: -5px;}
        .tl-item.active-now { animation: pulseGlow 2.5s infinite; padding: 15px 10px; margin: 5px -10px; border: 1px solid rgba(255,255,255,0.05); }
        .tl-item.active-now::before { content: '–ó–ê–†–ê–ó'; position: absolute; right: 15px; top: 15px; font-size: 10px; font-weight: 900; background: #fff; color: #000; padding: 3px 8px; border-radius: 8px; letter-spacing: 0.5px; }
        .tl-item.past-interval { opacity: 0.35; filter: grayscale(0.8); }

        .tl-head { display: flex; align-items: center; min-height: 40px; position: relative; z-index: 2; }
        .time-col { width: 70px; text-align: right; padding-right: 15px; font-weight: 800; font-size: 20px; flex-shrink: 0; line-height: 1; margin: 0; letter-spacing: -0.5px; } 
        .time-col.off { color: var(--c-red); }
        .time-col.on { color: var(--c-yellow); text-shadow: 0 0 10px rgba(251, 191, 36, 0.4); }

        .icon-node { display: flex; flex-direction: column; align-items: center; width: 40px; flex-shrink: 0; }
        .icon-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #111; border: 1px solid #222; z-index: 3; position: relative; }
        .icon-house { width: 22px; height: 22px; }
        .on .icon-house { fill: var(--c-yellow); filter: drop-shadow(0 0 5px var(--c-yellow)); }
        .off .icon-house { fill: #555; }

        .badge-col { padding-left: 15px; flex-grow: 1; display: flex; align-items: center; }
        .badge { display: flex; align-items: center; justify-content: center; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 800; letter-spacing: 0.5px; width: max-content; line-height: 1; text-transform: uppercase; gap: 6px; } 
        .badge.off { background: #1a1a1c; border: 1px solid #333; color: #a1a1aa; }
        .badge.on { background: rgba(251, 191, 36, 0.1); color: var(--c-yellow); border: 1px solid var(--c-yellow); }
        .badge-row { display: flex; align-items: center; flex-wrap: wrap; gap: 8px; }
        .badge-modifier { font-size: 12px; font-weight: 800; text-transform: uppercase; }
        .badge-modifier.rescued { color: var(--c-yellow); }
        .badge-modifier.emergency { color: var(--c-red); }

        .tl-body { display: flex; align-items: stretch; min-height: 50px; position: relative; z-index: 1; } 
        .line-node { display: flex; flex-direction: column; align-items: center; justify-content: space-evenly; width: 40px; flex-shrink: 0; padding: 10px 0; margin: 0; }
        .tl-dot-micro { width: 6px; height: 6px; border-radius: 50%; opacity: 0.9; flex-shrink: 0; margin: 3px 0; } 
        .tl-dot-micro.on { background: var(--c-yellow); box-shadow: 0 0 4px rgba(251, 191, 36, 0.5); }
        .tl-dot-micro.off { background: #555; }
        .active-now .tl-dot-micro { animation: breath 2s infinite ease-in-out; }

        .interval-col { padding-left: 15px; flex-grow: 1; display: flex; align-items: center; }
        .interval { display: flex; align-items: center; gap: 8px; font-size: 18px; font-weight: 700; line-height: 1; } 
        .interval-icon { display: flex; align-items: center; justify-content: center; width: 20px; height: 20px; flex-shrink: 0; }
        .interval-icon svg { width: 100%; height: 100%; display: block; }
        .interval.off { color: var(--c-red); }
        .interval.on { color: var(--c-yellow); }

        .waiting-block { text-align: center; padding: 30px 20px; color: #888; font-weight: 700; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        
        /* –ë–õ–Æ–† –ê–í–ê–†–Ü–á */
        .emergency-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 15, 15, 0.85);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 20px; text-align: center; padding: 20px; cursor: pointer;
            transition: opacity 0.4s ease;
        }
        .emergency-overlay.hidden-temp { opacity: 0; pointer-events: none; }
        .em-alert-title { font-size: 26px; font-weight: 900; color: var(--c-red); margin: 15px 0 10px; text-transform: uppercase; letter-spacing: 1px;}
        .em-alert-time { font-size: 18px; font-weight: 800; color: #000; background: var(--c-red); padding: 6px 16px; border-radius: 12px; display: inline-block;}
        .em-hint { font-size: 13px; color: rgba(255,255,255,0.5); margin-top: 25px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;}

        /* === –§–£–¢–ï–† === */
        .app-footer { margin-top: 10px; padding: 25px 20px 40px; border-top: 1px solid rgba(255,255,255,0.05); text-align: center; }
        .footer-links { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .f-link { color: #888; text-decoration: none; font-size: 13px; font-weight: 700; background: rgba(255,255,255,0.05); padding: 8px 16px; border-radius: 20px; transition: 0.2s; }
        .f-link:active { background: rgba(255,255,255,0.1); color: #fff; }
        
        .disclaimer-box { display: flex; align-items: flex-start; text-align: left; gap: 8px; font-size: 13px; color: #777; line-height: 1.4; font-weight: 500; background: rgba(255,255,255,0.03); padding: 12px 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05);}
        .source-text { font-size: 12px; color: #666; font-weight: 500; }

        .loader { text-align: center; color: #888; margin-top: 50px; font-weight: bold; }
    </style>
</head>
<body>

<div id="loader" class="loader">–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ –û–±–ª–µ–Ω–µ—Ä–≥–æ... ‚ö°</div>

<div id="app" style="display: none;">
    <div class="sticky-header">
        <div class="header-top">
            <div class="branding">
                <img src="./logo.png" alt="" class="logo-img" onerror="this.style.display='none'">
                <h1 class="app-title">
                    <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                    –í–ê–õ–ö–ò
                </h1>
            </div>
            <div class="date-badge" id="dateDisplay">–°–¨–û–ì–û–î–ù–Ü</div>
        </div>
        <div class="dashboard">
            <div class="status-box">
                <div class="status-label">–°—Ç–∞—Ç—É—Å</div>
                <div class="status-value" id="timerStatus">...</div>
            </div>
            <div class="timer-box">
                <div class="timer-label" id="timerLabel">–û–Ω–æ–≤–ª–µ–Ω–Ω—è...</div>
                <div class="timer-time" id="timerDisplay">--:--:--</div>
            </div>
        </div>
    </div>

    <div id="timelineContainer"></div>
    
    <div class="app-footer">
        <div class="footer-links">
            <a href="https://t.me/valkychat" class="f-link" target="_blank">üí¨ –ß–∞—Ç</a>
            <a href="https://t.me/valkybazar" class="f-link" target="_blank">üì£ –ë–∞–∑–∞—Ä—á–∏–∫</a>
        </div>
        <div class="disclaimer-box">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink: 0; margin-top: 1px;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            <div>–§–∞–∫—Ç–∏—á–Ω–∏–π —á–∞—Å –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –º–æ–∂–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏—Å—è –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Å—Ç–∞–Ω—É –µ–Ω–µ—Ä–≥–æ—Å–∏—Å—Ç–µ–º–∏.</div>
        </div>
        <div class="source-text"><b>–î–∂–µ—Ä–µ–ª–æ:</b><br>–•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ</div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.setHeaderColor('#060606');
    tg.setBackgroundColor('#060606');

    const BIN_ID = '699b325fd0ea881f40cf7aaf'; 

    const houseSvg = `<svg class="icon-house" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>`;
    const iconBan = `<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>`;
    const iconLightningSVG = `<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`;
    const iconBulb = `<svg class="interval-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1.2 1.5-2.5 1.5-4a6 6 0 0 0-6-6 6 6 0 0 0-6 6c0 1.4.5 2.7 1.5 4 .7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>`;
    const iconZapOff = `<svg class="interval-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="2" y1="2" x2="22" y2="22"></line><path d="M8.5 8.5L3 14h9l-1 8 5.5-5.5"></path><path d="M16 10h5l-1.5 1.5"></path><path d="M12.4 6.6L13 2l-2.6 2.6"></path></svg>`;
    
    // –Ü–∫–æ–Ω–∫–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å—É
    const statusIconOn = `<svg viewBox="0 0 24 24" width="16" height="16" fill="var(--c-yellow)"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`;
    const statusIconOff = `<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="var(--c-red)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="2" y1="2" x2="22" y2="22"></line><path d="M8.5 8.5L3 14h9l-1 8 5.5-5.5"></path><path d="M16 10h5l-1.5 1.5"></path><path d="M12.4 6.6L13 2l-2.6 2.6"></path></svg>`;

    let globalIntervals = [];
    let emergencyData = null;
    let initialScrollDone = false;

    async function fetchData() {
        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`);
            const result = await response.json();
            const data = result.record;
            
            document.getElementById('dateDisplay').textContent = data.date;
            globalIntervals = data.intervals || [];
            emergencyData = data.emergency || { active: false };
            
            document.getElementById('loader').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            
            startTimerAndRender(); 
        } catch (error) {
            document.getElementById('loader').textContent = "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π –ø—ñ–∑–Ω—ñ—à–µ.";
        }
    }

    function renderTimeline(currentMins) {
        const container = document.getElementById('timelineContainer');
        let html = '';

        if (globalIntervals.length === 0) {
            container.innerHTML = `<div class="waiting-block">‚è≥ –û—á—ñ–∫—É—î–º–æ –Ω–∞ –≥—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥ –û–±–ª–µ–Ω–µ—Ä–≥–æ</div>`;
            return;
        }

        globalIntervals.forEach((int, i) => {
            const isVisuallyOn = int.type === 'on';
            const stateClass = isVisuallyOn ? 'on' : 'off';
            
            const isActive = (currentMins >= int.startMin && currentMins < int.endMin);
            const isPast = (currentMins >= int.endMin); 
            
            let classes = `tl-item ${stateClass}`;
            if (isActive) classes += ' active-now';
            if (isPast) classes += ' past-interval';

            let badgeHtml = '';
            let intervalTextStyle = '';

            if (int.type === 'off') {
                if (int.isModified) {
                    badgeHtml = `<div class="badge-row"><div class="badge off" style="text-decoration: line-through; opacity: 0.5;">${iconBan} –í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø</div><span class="badge-modifier rescued">üí° –ë—É–ª–æ</span></div>`;
                    intervalTextStyle = `color: rgba(251, 191, 36, 0.7); text-decoration: line-through; text-decoration-color: rgba(251, 191, 36, 0.7);`;
                } else {
                    badgeHtml = `<div class="badge off"><span style="color:var(--c-red); display:flex;">${iconBan}</span> –í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø</div>`;
                }
            } else {
                if (int.isModified) {
                    badgeHtml = `<div class="badge-row"><div class="badge on" style="text-decoration: line-through; opacity: 0.5;">${iconLightningSVG} –°–í–Ü–¢–õ–û –Ñ</div><span class="badge-modifier emergency">‚ö†Ô∏è –ê–≤–∞—Ä—ñ–π–Ω–µ</span></div>`;
                    intervalTextStyle = `color: #888; text-decoration: line-through; text-decoration-color: #888;`;
                } else {
                    badgeHtml = `<div class="badge on">${iconLightningSVG} –°–í–Ü–¢–õ–û –Ñ</div>`;
                }
            }

            const intIcon = isVisuallyOn ? iconBulb : iconZapOff;
            
            let durationMins = int.endMin - int.startMin;
            if (durationMins < 0) durationMins += 1440; 
            let hours = durationMins / 60;
            let fullDots = Math.floor(hours);
            let hasHalfDot = (hours - fullDots) >= 0.4; 

            let dotsHtml = '';
            if (i < globalIntervals.length - 1) { 
                for(let d = 0; d < fullDots; d++) dotsHtml += `<div class="tl-dot-micro ${stateClass}"></div>`;
                if(hasHalfDot) {
                    let halfColor = isVisuallyOn ? "var(--c-yellow)" : "#555";
                    dotsHtml += `<div class="tl-dot-micro" style="background: linear-gradient(to bottom, ${halfColor} 50%, transparent 50%); border: 1px solid ${halfColor}; box-sizing: border-box;"></div>`;
                }
                if(fullDots === 0 && !hasHalfDot) dotsHtml += `<div class="tl-dot-micro ${stateClass}" style="transform: scale(0.6);"></div>`;
            } else {
                dotsHtml += `<div class="tl-dot-micro ${stateClass}" style="opacity: 0.6; transform: scale(0.8);"></div>`;
                dotsHtml += `<div class="tl-dot-micro ${stateClass}" style="opacity: 0.3; transform: scale(0.6);"></div>`;
            }

            html += `
            <div class="${classes}">
                <div class="tl-head">
                    <div class="time-col ${stateClass}">${int.startStr}</div>
                    <div class="icon-node"><div class="icon-circle">${houseSvg}</div></div>
                    <div class="badge-col">${badgeHtml}</div>
                </div>
                <div class="tl-body">
                    <div class="time-col"></div>
                    <div class="line-node">${dotsHtml}</div>
                    <div class="interval-col">
                        <div class="interval ${stateClass}">
                            <div class="interval-icon">${intIcon}</div>
                            <span class="interval-text" style="${intervalTextStyle}">${int.startStr} - ${int.displayEndStr}</span>
                        </div>
                    </div>
                </div>
            </div>`;
        });

        // –ë–ª–æ–∫ "–û—á—ñ–∫—É—î–º–æ –∑–∞–≤—Ç—Ä–∞"
        if (globalIntervals.length > 0) {
            html += `<div class="waiting-block" style="margin-top: 10px;">–û—á—ñ–∫—É—î–º–æ –≥—Ä–∞—Ñ—ñ–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞...</div>`;
        }

        // –†–µ–Ω–¥–µ—Ä –æ–≤–µ—Ä–ª–µ—é –∞–≤–∞—Ä—ñ—ó
        if (emergencyData && emergencyData.active) {
            let emTimeText = "";
            if (emergencyData.start && emergencyData.end) emTimeText = `–∑ ${emergencyData.start} –¥–æ ${emergencyData.end}`;
            else if (emergencyData.start) emTimeText = `–∑ ${emergencyData.start}`;

            html += `
            <div class="emergency-overlay" id="emOverlay" onclick="hideEmergencyTemp()">
                <svg viewBox="0 0 24 24" width="56" height="56" fill="none" stroke="var(--c-red)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 10px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                <div class="em-alert-title">–ê–í–ê–†–Ü–ô–ù–ï –í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø</div>
                ${emTimeText ? `<div class="em-alert-time">${emTimeText}</div>` : ''}
                <div class="em-hint">–¢–∞–ø–Ω–∏, —â–æ–± –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫</div>
            </div>`;
        }

        container.innerHTML = html;

        if (!initialScrollDone) {
            setTimeout(() => {
                const activeEl = document.querySelector('.active-now');
                if (activeEl) activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                initialScrollDone = true;
            }, 300);
        }
    }

    // –§—É–Ω–∫—Ü—ñ—è –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è –±–ª—é—Ä—É –Ω–∞ 4 —Å–µ–∫—É–Ω–¥–∏
    window.hideEmergencyTemp = function() {
        const el = document.getElementById('emOverlay');
        if(el) {
            el.classList.add('hidden-temp');
            setTimeout(() => el.classList.remove('hidden-temp'), 4000);
        }
    }

    function startTimerAndRender() {
        let lastRenderedIntervalIndex = -1;

        setInterval(() => {
            const now = new Date();
            const currentMins = now.getHours() * 60 + now.getMinutes();
            const currentSecs = now.getSeconds();
            
            let currentIntIndex = -1;
            let currentState = null;
            let nextEventMins = null;

            for (let i = 0; i < globalIntervals.length; i++) {
                let int = globalIntervals[i];
                if (currentMins >= int.startMin && currentMins < int.endMin) {
                    currentIntIndex = i;
                    currentState = (int.type === 'off' && !int.isModified) || (int.type === 'on' && int.isModified) ? 'off' : 'on';
                    nextEventMins = int.endMin;
                    break;
                }
            }

            // –Ø–∫—â–æ —É–≤—ñ–º–∫–Ω–µ–Ω–∞ –∞–≤–∞—Ä—ñ—è, —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–º—É—Å–æ–≤–æ "–°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞—î"
            if (emergencyData && emergencyData.active) {
                currentState = 'off';
            }

            if (currentIntIndex !== lastRenderedIntervalIndex) {
                renderTimeline(currentMins);
                lastRenderedIntervalIndex = currentIntIndex;
            }

            const timerDisplay = document.getElementById('timerDisplay');
            const timerLabel = document.getElementById('timerLabel');
            const timerStatus = document.getElementById('timerStatus');

            if (globalIntervals.length === 0) {
                timerDisplay.textContent = "--:--:--";
                timerLabel.textContent = "–û—á—ñ–∫—É–≤–∞–Ω–Ω—è";
                timerStatus.innerHTML = `${iconBulb} –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö`;
                timerStatus.style.color = '#888';
                return;
            }

            if (nextEventMins !== null && !(emergencyData && emergencyData.active)) {
                let diffMins = nextEventMins - currentMins - 1;
                let diffSecs = 60 - currentSecs;
                if(diffSecs === 60) { diffSecs = 0; diffMins++; }

                let h = Math.floor(diffMins / 60).toString().padStart(2, '0');
                let m = (diffMins % 60).toString().padStart(2, '0');
                let s = diffSecs.toString().padStart(2, '0');

                timerDisplay.textContent = `${h}:${m}:${s}`;

                if (currentState === 'off') {
                    timerDisplay.className = 'timer-time off';
                    timerLabel.textContent = '–î–æ –≤–∫–ª—é—á–µ–Ω–Ω—è:';
                    timerStatus.innerHTML = `${statusIconOff} –°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞—î`;
                    timerStatus.style.color = 'var(--c-red)';
                } else {
                    timerDisplay.className = 'timer-time on';
                    timerLabel.textContent = '–î–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:';
                    timerStatus.innerHTML = `${statusIconOn} –°–≤—ñ—Ç–ª–æ —î`;
                    timerStatus.style.color = 'var(--c-yellow)';
                }
            } else if (emergencyData && emergencyData.active) {
                // –Ø–∫—â–æ –∞–≤–∞—Ä—ñ—è ‚Äî —Ç–∞–π–º–µ—Ä –∑—É–ø–∏–Ω—è—î–º–æ
                timerDisplay.textContent = "--:--:--";
                timerDisplay.className = 'timer-time off';
                timerLabel.textContent = '–ê–≤–∞—Ä—ñ–π–Ω–∏–π —Ä–µ–∂–∏–º';
                timerStatus.innerHTML = `${statusIconOff} –°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞—î`;
                timerStatus.style.color = 'var(--c-red)';
            } else {
                timerDisplay.textContent = "00:00:00";
                timerLabel.textContent = "–î–æ–±–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞";
                timerStatus.innerHTML = `<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> –û–Ω–æ–≤–ª—é—î–º–æ`;
                timerStatus.style.color = '#888';
            }
        }, 1000);
    }

    fetchData();
</script>
</body>
</html>
