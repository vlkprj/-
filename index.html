<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELECTRIFY ‚Ä¢ –í–ê–õ–ö–ò</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --c-yellow: #fbbf24; 
            --c-red: #d9463b; 
            --c-dark: #060606;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--c-dark);
            color: #ffffff;
            margin: 0; padding: 0;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        /* === –§–Ü–ö–°–û–í–ê–ù–ò–ô –•–ï–î–ï–† –ó –¢–ê–ô–ú–ï–†–û–ú === */
        .sticky-header {
            position: sticky; top: 0; left: 0; width: 100%;
            background: rgba(6, 6, 6, 0.85);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            z-index: 100; padding: 20px; box-sizing: border-box;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .app-title { font-size: 20px; font-weight: 900; letter-spacing: 0.5px; margin: 0; }
        .date-badge { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 10px; font-weight: 800; color: var(--c-yellow); font-size: 13px; }

        .timer-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .timer-info { display: flex; flex-direction: column; gap: 4px; }
        .timer-label { font-size: 12px; color: #888; font-weight: 700; text-transform: uppercase; }
        .timer-status { font-size: 14px; font-weight: 800; }
        .timer-time { font-size: 36px; font-weight: 900; line-height: 1; font-variant-numeric: tabular-nums; }
        .timer-time.off { color: var(--c-red); text-shadow: 0 0 15px rgba(217, 70, 59, 0.4); }
        .timer-time.on { color: var(--c-yellow); text-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }

        /* === –¢–ê–ô–ú–õ–ê–ô–ù (–ï–°–¢–ï–¢–ò–ö–ê –°–ú–ê–†–¢-–î–Ü–ú) === */
        #timelineContainer { padding: 25px 20px; display: flex; flex-direction: column; gap: 0; }
        
        /* –ê–Ω—ñ–º–∞—Ü—ñ—è –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —ñ–Ω—Ç–µ—Ä–≤–∞–ª—É */
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); }
            50% { box-shadow: 0 0 20px 0 rgba(255,255,255,0.05); background: rgba(255,255,255,0.08); }
            100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); background: rgba(255,255,255,0.03); }
        }
        .tl-item { display: flex; flex-direction: column; z-index: 2; position: relative; padding: 10px 0; transition: 0.3s ease; border-radius: 16px; margin-bottom: -5px;}
        .tl-item.active-now { animation: pulseGlow 2.5s infinite; padding: 15px 10px; margin: 5px -10px; }
        .tl-item.active-now::before { content: '–ó–ê–†–ê–ó'; position: absolute; right: 15px; top: 15px; font-size: 10px; font-weight: 900; background: #fff; color: #000; padding: 2px 6px; border-radius: 6px; }

        .tl-head { display: flex; align-items: center; min-height: 40px; position: relative; z-index: 2; }
        .time-col { width: 70px; text-align: right; padding-right: 15px; font-weight: 800; font-size: 20px; flex-shrink: 0; line-height: 1; margin: 0; letter-spacing: -0.5px; } 
        .time-col.off { color: var(--c-red); }
        .time-col.on { color: var(--c-yellow); text-shadow: 0 0 10px rgba(251, 191, 36, 0.4); }

        .icon-node { display: flex; flex-direction: column; align-items: center; width: 40px; flex-shrink: 0; }
        .icon-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #111; border: 1px solid #222; z-index: 3; position: relative; }
        .icon-house { width: 22px; height: 22px; }
        .on .icon-house { fill: var(--c-yellow); filter: drop-shadow(0 0 5px var(--c-yellow)); }
        .off .icon-house { fill: #555; }

        .badge-col { padding-left: 15px; flex-grow: 1; display: flex; align-items: center; }
        .badge { display: flex; align-items: center; justify-content: center; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 800; letter-spacing: 0.5px; width: max-content; line-height: 1; text-transform: uppercase; gap: 6px; } 
        .badge.off { background: #1a1a1c; border: 1px solid #333; color: #a1a1aa; }
        .badge.on { background: rgba(251, 191, 36, 0.1); color: var(--c-yellow); border: 1px solid var(--c-yellow); }
        .badge-row { display: flex; align-items: center; flex-wrap: wrap; gap: 8px; }
        .badge-modifier { font-size: 12px; font-weight: 800; text-transform: uppercase; }
        .badge-modifier.rescued { color: var(--c-yellow); }
        .badge-modifier.emergency { color: var(--c-red); }

        .tl-body { display: flex; align-items: stretch; min-height: 40px; position: relative; z-index: 1; } 
        .line-node { display: flex; flex-direction: column; align-items: center; justify-content: space-evenly; width: 40px; flex-shrink: 0; padding: 4px 0; margin: 0; }
        .tl-dot-micro { width: 6px; height: 6px; border-radius: 50%; opacity: 0.9; flex-shrink: 0;} 
        .tl-dot-micro.on { background: var(--c-yellow); box-shadow: 0 0 4px rgba(251, 191, 36, 0.5); }
        .tl-dot-micro.off { background: #555; }

        .interval-col { padding-left: 15px; flex-grow: 1; display: flex; align-items: center; }
        .interval { display: flex; align-items: center; gap: 8px; font-size: 18px; font-weight: 700; line-height: 1; } 
        .interval-icon { display: flex; align-items: center; justify-content: center; width: 20px; height: 20px; flex-shrink: 0; }
        .interval-icon svg { width: 100%; height: 100%; display: block; }
        .interval-text { display: flex; align-items: center; line-height: 1; }
        .interval.off { color: var(--c-red); }
        .interval.on { color: var(--c-yellow); }

        .loader { text-align: center; color: #888; margin-top: 50px; font-weight: bold; }
    </style>
</head>
<body>

<div id="loader" class="loader">–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ –û–±–ª–µ–Ω–µ—Ä–≥–æ... ‚ö°</div>

<div id="app" style="display: none;">
    <div class="sticky-header">
        <div class="header-top">
            <h1 class="app-title">ELECTRIFY ‚Ä¢ –í–ê–õ–ö–ò</h1>
            <div class="date-badge" id="dateDisplay">–°–¨–û–ì–û–î–ù–Ü</div>
        </div>
        <div class="timer-row">
            <div class="timer-info">
                <div class="timer-label" id="timerLabel">–°—Ç–∞—Ç—É—Å</div>
                <div class="timer-status" id="timerStatus">...</div>
            </div>
            <div class="timer-time" id="timerDisplay">--:--:--</div>
        </div>
    </div>

    <div id="timelineContainer">
        </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.setHeaderColor('#060606');
    tg.setBackgroundColor('#060606');

    // –¢–í–û–á –î–ê–ù–Ü –ó JSONBIN
    const BIN_ID = '699b0c39d0ea881f40cf2acc'; 
    const API_KEY = '$2a$10$eJ1fwUqfEQDl/1c.6w1GTOuCkNADdRjDwvpKTuXaRXaUeIZu0MD.W'; 

    // –Ü–∫–æ–Ω–∫–∏ (SVG –∑ —Ç–≤–æ—î—ó –∞–¥–º—ñ–Ω–∫–∏)
    const houseSvg = `<svg class="icon-house" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>`;
    const iconBan = `<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>`;
    const iconLightningSVG = `<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`;
    const iconBulb = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1.2 1.5-2.5 1.5-4a6 6 0 0 0-6-6 6 6 0 0 0-6 6c0 1.4.5 2.7 1.5 4 .7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>`;
    const iconZapOff = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="2" y1="2" x2="22" y2="22"></line><path d="M8.5 8.5L3 14h9l-1 8 5.5-5.5"></path><path d="M16 10h5l-1.5 1.5"></path><path d="M12.4 6.6L13 2l-2.6 2.6"></path></svg>`;

    let globalIntervals = [];

    async function fetchData() {
        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                headers: { 'X-Master-Key': API_KEY }
            });
            const result = await response.json();
            const data = result.record;
            
            document.getElementById('dateDisplay').textContent = data.date;
            globalIntervals = data.intervals;
            
            document.getElementById('loader').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            
            startTimerAndRender(); // –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ä–µ–Ω–¥–µ—Ä —ñ —Ç–∞–π–º–µ—Ä –æ–¥–Ω–æ—á–∞—Å–Ω–æ
        } catch (error) {
            document.getElementById('loader').textContent = "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π –ø—ñ–∑–Ω—ñ—à–µ.";
        }
    }

    function renderTimeline(currentMins) {
        const container = document.getElementById('timelineContainer');
        let html = '';

        globalIntervals.forEach((int, i) => {
            const isVisuallyOn = int.type === 'on';
            const stateClass = isVisuallyOn ? 'on' : 'off';
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Ü–µ–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª –∞–∫—Ç–∏–≤–Ω–∏–π –∑–∞—Ä–∞–∑
            const isActive = (currentMins >= int.startMin && currentMins < int.endMin);
            const activeClass = isActive ? 'active-now' : '';

            let badgeHtml = '';
            let intervalTextStyle = '';

            // –õ–æ–≥—ñ–∫–∞ –∞–≤–∞—Ä—ñ–π / —Å–∫–∞—Å—É–≤–∞–Ω—å
            if (int.type === 'off') {
                if (int.isModified) {
                    badgeHtml = `<div class="badge-row"><div class="badge off" style="text-decoration: line-through; opacity: 0.5;">${iconBan} –í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø</div><span class="badge-modifier rescued">üí° –°–≤—ñ—Ç–ª–æ –±—É–ª–æ</span></div>`;
                    intervalTextStyle = `color: rgba(251, 191, 36, 0.7); text-decoration: line-through; text-decoration-color: rgba(251, 191, 36, 0.7);`;
                } else {
                    badgeHtml = `<div class="badge off"><span style="color:var(--c-red); display:flex;">${iconBan}</span> –í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø</div>`;
                }
            } else {
                if (int.isModified) {
                    badgeHtml = `<div class="badge-row"><div class="badge on" style="text-decoration: line-through; opacity: 0.5;">${iconLightningSVG} –°–í–Ü–¢–õ–û –Ñ</div><span class="badge-modifier emergency">‚ö†Ô∏è –ê–≤–∞—Ä—ñ–π–Ω–µ</span></div>`;
                    intervalTextStyle = `color: #888; text-decoration: line-through; text-decoration-color: #888;`;
                } else {
                    badgeHtml = `<div class="badge on">${iconLightningSVG} –°–í–Ü–¢–õ–û –Ñ</div>`;
                }
            }

            const intIcon = isVisuallyOn ? iconBulb : iconZapOff;
            
            // –†–∞—Ö—É—î–º–æ –∫—Ä—É–∂–µ—á–∫–∏
            let durationMins = int.endMin - int.startMin;
            if (durationMins < 0) durationMins += 1440; 
            let hours = durationMins / 60;
            let fullDots = Math.floor(hours);
            let hasHalfDot = (hours - fullDots) >= 0.4; 

            let dotsHtml = '';
            if (i < globalIntervals.length - 1) { 
                for(let d = 0; d < fullDots; d++) dotsHtml += `<div class="tl-dot-micro ${stateClass}"></div>`;
                if(hasHalfDot) {
                    let halfColor = isVisuallyOn ? "var(--c-yellow)" : "#555";
                    dotsHtml += `<div class="tl-dot-micro" style="background: linear-gradient(to bottom, ${halfColor} 50%, transparent 50%); border: 1px solid ${halfColor}; box-sizing: border-box;"></div>`;
                }
                if(fullDots === 0 && !hasHalfDot) dotsHtml += `<div class="tl-dot-micro ${stateClass}" style="transform: scale(0.6);"></div>`;
            } else {
                dotsHtml += `<div class="tl-dot-micro ${stateClass}" style="opacity: 0.6; transform: scale(0.8);"></div>`;
                dotsHtml += `<div class="tl-dot-micro ${stateClass}" style="opacity: 0.3; transform: scale(0.6);"></div>`;
            }

            html += `
            <div class="tl-item ${stateClass} ${activeClass}">
                <div class="tl-head">
                    <div class="time-col ${stateClass}">${int.startStr}</div>
                    <div class="icon-node"><div class="icon-circle">${houseSvg}</div></div>
                    <div class="badge-col">${badgeHtml}</div>
                </div>
                <div class="tl-body">
                    <div class="time-col"></div>
                    <div class="line-node">${dotsHtml}</div>
                    <div class="interval-col">
                        <div class="interval ${stateClass}">
                            <div class="interval-icon">${intIcon}</div>
                            <span class="interval-text" style="${intervalTextStyle}">${int.startStr} - ${int.displayEndStr}</span>
                        </div>
                    </div>
                </div>
            </div>`;
        });

        container.innerHTML = html;
    }

    function startTimerAndRender() {
        let lastRenderedIntervalIndex = -1;

        setInterval(() => {
            const now = new Date();
            const currentMins = now.getHours() * 60 + now.getMinutes();
            const currentSecs = now.getSeconds();
            
            let currentIntIndex = -1;
            let currentState = null;
            let nextEventMins = null;

            // –®—É–∫–∞—î–º–æ, –≤ —è–∫–æ–º—É –º–∏ –∑–∞—Ä–∞–∑ —ñ–Ω—Ç–µ—Ä–≤–∞–ª—ñ
            for (let i = 0; i < globalIntervals.length; i++) {
                let int = globalIntervals[i];
                if (currentMins >= int.startMin && currentMins < int.endMin) {
                    currentIntIndex = i;
                    // –í—Ä–∞—Ö–æ–≤—É—î–º–æ –∞–≤–∞—Ä—ñ–π–Ω—ñ –∑–º—ñ–Ω–∏ –¥–ª—è —Ç–∞–π–º–µ—Ä–∞
                    currentState = (int.type === 'off' && !int.isModified) || (int.type === 'on' && int.isModified) ? 'off' : 'on';
                    nextEventMins = int.endMin;
                    break;
                }
            }

            // –ü–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î–º–æ —Ç–∞–π–º–ª–∞–π–Ω —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∑–º—ñ–Ω–∏–≤—Å—è –ø–æ—Ç–æ—á–Ω–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª (—â–æ–± –Ω–µ –ª–∞–≥–∞–ª–æ)
            if (currentIntIndex !== lastRenderedIntervalIndex) {
                renderTimeline(currentMins);
                lastRenderedIntervalIndex = currentIntIndex;
            }

            const timerDisplay = document.getElementById('timerDisplay');
            const timerLabel = document.getElementById('timerLabel');
            const timerStatus = document.getElementById('timerStatus');

            if (nextEventMins !== null) {
                let diffMins = nextEventMins - currentMins - 1;
                let diffSecs = 60 - currentSecs;
                if(diffSecs === 60) { diffSecs = 0; diffMins++; }

                let h = Math.floor(diffMins / 60).toString().padStart(2, '0');
                let m = (diffMins % 60).toString().padStart(2, '0');
                let s = diffSecs.toString().padStart(2, '0');

                timerDisplay.textContent = `${h}:${m}:${s}`;

                if (currentState === 'off') {
                    timerDisplay.className = 'timer-time off';
                    timerLabel.textContent = '–î–æ –≤–∫–ª—é—á–µ–Ω–Ω—è:';
                    timerStatus.textContent = 'üåë –°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞—î';
                    timerStatus.style.color = 'var(--c-red)';
                } else {
                    timerDisplay.className = 'timer-time on';
                    timerLabel.textContent = '–î–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:';
                    timerStatus.textContent = 'üí° –°–≤—ñ—Ç–ª–æ —î';
                    timerStatus.style.color = 'var(--c-yellow)';
                }
            } else {
                timerDisplay.textContent = "00:00:00";
                timerLabel.textContent = "–û–Ω–æ–≤–ª–µ–Ω–Ω—è...";
                timerStatus.textContent = "–ì—Ä–∞—Ñ—ñ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–æ";
            }
        }, 1000);
    }

    fetchData();
</script>
</body>
</html>
