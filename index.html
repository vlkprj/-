
<!DOCTYPE html>

<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–í–ê–õ–ö–ò ‚Ä¢ –ì—Ä–∞—Ñ—ñ–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --c-yellow: #fbbf24; --c-red: #d9463b; --c-dark: #060606;
        }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background-color: var(--c-dark); color: #ffffff;
        margin: 0; padding: 0; -webkit-font-smoothing: antialiased; overflow-x: hidden;
    }

    .sticky-header {
        position: sticky; top: 0; left: 0; width: 100%;
        background: rgba(6, 6, 6, 0.85);
        backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
        z-index: 100; padding: 15px 20px; box-sizing: border-box;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }

    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .branding { display: flex; align-items: center; gap: 8px; }
    .logo-img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background: #ffffff; border: 1px solid #eee; padding: 2px; box-sizing: border-box; }
    .app-title { font-size: 20px; font-weight: 900; letter-spacing: 0.5px; margin: 0; display: flex; align-items: center; gap: 6px; }
    .app-title svg { fill: var(--c-yellow); width: 22px; height: 22px; margin-top: -2px; }
    .date-badge { background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 12px; font-weight: 800; color: var(--c-yellow); font-size: 13px; }

    .dashboard { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 5px; }
    .status-box { display: flex; flex-direction: column; gap: 8px; justify-content: flex-end; }
    .status-label { font-size: 12px; color: #888; font-weight: 800; text-transform: uppercase; display: flex; align-items: center; letter-spacing: 0.5px; margin-bottom: 2px; }
    .status-value { display: flex; align-items: center; gap: 6px; font-size: 18px; font-weight: 800; line-height: 1; margin-bottom: 4px; }

    .live-dot { display: inline-block; width: 8px; height: 8px; background-color: var(--c-red); border-radius: 50%; margin-right: 6px; animation: blinkFast 1.5s infinite; }
    @keyframes blinkFast { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }

    .timer-box { text-align: right; }
    .timer-label { font-size: 12px; color: #888; font-weight: 700; text-transform: uppercase; margin-bottom: 2px; }
    .timer-time { font-size: 34px; font-weight: 900; line-height: 1; font-variant-numeric: tabular-nums; letter-spacing: -1px; }
    .timer-time.off { color: var(--c-red); text-shadow: 0 0 15px rgba(217, 70, 59, 0.4); }
    .timer-time.on { color: var(--c-yellow); text-shadow: 0 0 15px rgba(251, 191, 36, 0.4); }

    #timelineContainer { padding: 20px; display: flex; flex-direction: column; gap: 0; min-height: 60vh; position: relative; }

    @keyframes pulseGlow {
        0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.05); background: rgba(255,255,255,0.02); }
        50% { box-shadow: 0 0 20px 0 rgba(255,255,255,0.08); background: rgba(255,255,255,0.06); }
        100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); background: rgba(255,255,255,0.02); }
    }
    @keyframes pulseGlowRed {
        0% { box-shadow: 0 0 0 0 rgba(217,70,59,0.1); background: rgba(217,70,59,0.04); }
        50% { box-shadow: 0 0 20px 0 rgba(217,70,59,0.15); background: rgba(217,70,59,0.08); }
        100% { box-shadow: 0 0 0 0 rgba(217,70,59,0); background: rgba(217,70,59,0.04); }
    }
    @keyframes breath { 0% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 0.7; } }
    @keyframes nowDot { 0%, 100% { opacity: 1; } 50% { opacity: 0.15; } }

    .tl-item { display: flex; flex-direction: column; z-index: 2; position: relative; padding: 10px 0; transition: 0.3s ease; border-radius: 16px; margin-bottom: -5px; }
    .tl-item.active-now { animation: pulseGlow 2.5s infinite; padding: 15px 10px; margin: 5px -10px; border: 1px solid rgba(255,255,255,0.05); }
    .tl-item.active-now.emergency-active { animation: pulseGlowRed 2.5s infinite; border-color: rgba(217,70,59,0.15); }
    .tl-item.active-now::before { content: ''; position: absolute; right: 18px; top: 20px; width: 7px; height: 7px; border-radius: 50%; background: rgba(255,255,255,0.7); animation: nowDot 2.5s ease-in-out infinite; }
    .tl-item.active-now.emergency-active::before { background: var(--c-red); }
    .tl-item.past-interval { opacity: 0.35; filter: grayscale(0.8); transition: all 0.2s ease; cursor: pointer; }
    .tl-item.past-interval:active { opacity: 1; filter: none; }

    .tl-head { display: flex; align-items: center; min-height: 40px; position: relative; z-index: 2; padding-right: 65px; }

    .time-col { width: 70px; text-align: right; padding-right: 15px; font-weight: 800; font-size: 20px; flex-shrink: 0; line-height: 1; margin: 0; letter-spacing: -0.5px; }
    .time-col.off { color: var(--c-red); }
    .time-col.on { color: var(--c-yellow); text-shadow: 0 0 10px rgba(251, 191, 36, 0.4); }
    .time-col.emergency { color: var(--c-red); }

    .icon-node { display: flex; flex-direction: column; align-items: center; width: 40px; flex-shrink: 0; }
    .icon-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #111; border: 1px solid #222; z-index: 3; position: relative; }
    .icon-house { width: 22px; height: 22px; }
    .on .icon-house { fill: var(--c-yellow); filter: drop-shadow(0 0 5px var(--c-yellow)); }
    .off .icon-house, .emergency .icon-house { fill: #555; }


    .badge-col { padding-left: 15px; flex-grow: 1; display: flex; align-items: center; }
    .badge { display: flex; align-items: center; justify-content: center; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 800; letter-spacing: 0.5px; width: max-content; line-height: 1; text-transform: uppercase; gap: 6px; }
    .badge.off { background: #1a1a1c; border: 1px solid #333; color: #a1a1aa; }
    .badge.on { background: rgba(251, 191, 36, 0.1); color: var(--c-yellow); border: 1px solid var(--c-yellow); }
    .badge.emergency { background: rgba(217,70,59,0.15); color: var(--c-red); border: 1px solid var(--c-red); }
    .badge-row { display: flex; align-items: center; flex-wrap: wrap; gap: 8px; }
    .badge-modifier { font-size: 12px; font-weight: 800; text-transform: uppercase; }
    .badge-modifier.rescued { color: var(--c-yellow); }
    .badge-modifier.emergency { color: var(--c-red); }

    .tl-body { display: flex; align-items: stretch; min-height: 50px; position: relative; z-index: 1; }
    .line-node { display: flex; flex-direction: column; align-items: center; justify-content: space-evenly; width: 40px; flex-shrink: 0; padding: 10px 0; margin: 0; }
    .tl-dot-micro { width: 6px; height: 6px; border-radius: 50%; opacity: 0.9; flex-shrink: 0; margin: 3px 0; }
    .tl-dot-micro.on { background: var(--c-yellow); box-shadow: 0 0 4px rgba(251, 191, 36, 0.5); }
    .tl-dot-micro.off { background: #555; }
    .tl-dot-micro.emergency { background: var(--c-red); box-shadow: 0 0 4px rgba(217,70,59,0.5); }
    .active-now .tl-dot-micro { animation: breath 2s infinite ease-in-out; }

    .interval-col { padding-left: 15px; flex-grow: 1; display: flex; align-items: center; }
    .interval { display: flex; align-items: center; gap: 8px; font-size: 18px; font-weight: 700; line-height: 1; }
    .interval-icon { display: flex; align-items: center; justify-content: center; width: 20px; height: 20px; flex-shrink: 0; }
    .interval-icon svg { width: 100%; height: 100%; display: block; }
    .interval.off { color: var(--c-red); }
    .interval.on { color: var(--c-yellow); }
    .interval.emergency { color: var(--c-red); }

    .waiting-block { text-align: center; padding: 30px 20px; color: #888; font-weight: 700; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }

    .app-footer { margin-top: 10px; padding: 25px 20px 40px; border-top: 1px solid rgba(255,255,255,0.05); text-align: center; }
    .footer-links { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
    .f-link { color: #888; text-decoration: none; font-size: 13px; font-weight: 700; background: rgba(255,255,255,0.05); padding: 8px 16px; border-radius: 20px; transition: 0.2s; }
    .f-link:active { background: rgba(255,255,255,0.1); color: #fff; }

    .disclaimer-box { display: flex; align-items: flex-start; text-align: left; gap: 8px; font-size: 13px; color: #777; line-height: 1.4; font-weight: 500; background: rgba(255,255,255,0.03); padding: 12px 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
    .source-text { font-size: 12px; color: #666; font-weight: 500; }

    .loader { text-align: center; color: #888; margin-top: 50px; font-weight: bold; }
</style>


</head>
<body ontouchstart="">

<div id="loader" class="loader">–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è...‚ö°</div>

<div id="app" style="display: none;">
    <div class="sticky-header">
        <div class="header-top">
            <div class="branding">
                <img src="./logo.png" alt="" class="logo-img" onerror="this.style.display='none'">
                <h1 class="app-title">
                    <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                    –í–ê–õ–ö–ò
                </h1>
            </div>
            <div class="date-badge" id="dateDisplay">–°–¨–û–ì–û–î–ù–Ü</div>
        </div>
        <div class="dashboard">
            <div class="status-box">
                <div class="status-label"><span class="live-dot"></span>–°—Ç–∞—Ç—É—Å</div>
                <div class="status-value" id="timerStatus">...</div>
            </div>
            <div class="timer-box">
                <div class="timer-label" id="timerLabel">–û–Ω–æ–≤–ª–µ–Ω–Ω—è...</div>
                <div class="timer-time" id="timerDisplay">--:--:--</div>
            </div>
        </div>
    </div>


<div id="timelineContainer"></div>

<div class="app-footer">
    <div class="footer-links">
        <a href="https://t.me/share/url?url=t.me/valkyelectrifybot/electric&text=üí°%20–ê–∫—Ç—É–∞–ª—å–Ω–∏–π%20–≥—Ä–∞—Ñ—ñ–∫%20–≤—ñ–¥–∫–ª—é—á–µ–Ω—å%20—Å–≤—ñ—Ç–ª–∞%20—É%20–í–∞–ª–∫–∞—Ö" class="f-link" target="_blank">‚ÜóÔ∏è –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è</a>
        <a href="https://t.me/valkychat" class="f-link" target="_blank">üí¨ –ß–∞—Ç</a>
        <a href="https://t.me/valkybazar" class="f-link" target="_blank">üì£ –ë–∞–∑–∞—Ä—á–∏–∫</a>
    </div>
    <div class="disclaimer-box">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink: 0; margin-top: 1px;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
        <div>–§–∞–∫—Ç–∏—á–Ω–∏–π —á–∞—Å —ñ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –º–æ–∂—É—Ç—å –∑–º—ñ–Ω—é–≤–∞—Ç–∏—Å—è –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Å—Ç–∞–Ω—É –µ–Ω–µ—Ä–≥–æ—Å–∏—Å—Ç–µ–º–∏.</div>
    </div>
    <div class="source-text"><b>–î–∂–µ—Ä–µ–ª–æ:</b><br>–•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ</div>
</div>


</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand(); tg.setHeaderColor('#060606'); tg.setBackgroundColor('#060606');

    const BIN_ID = '699b325fd0ea881f40cf7aaf';

    const houseSvg = `<svg class="icon-house" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>`;
    const iconBan = `<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>`;
    const iconLightningSVG = `<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`;
    const iconBulb = `<svg class="interval-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1.2 1.5-2.5 1.5-4a6 6 0 0 0-6-6 6 6 0 0 0-6 6c0 1.4.5 2.7 1.5 4 .7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>`;
    const iconZapOff = `<svg class="interval-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="2" y1="2" x2="22" y2="22"></line><path d="M8.5 8.5L3 14h9l-1 8 5.5-5.5"></path><path d="M16 10h5l-1.5 1.5"></path><path d="M12.4 6.6L13 2l-2.6 2.6"></path></svg>`;
    const iconWarning = `<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M12 2L1 21h22L12 2zm0 3.5L20.5 19h-17L12 5.5zM11 10v4h2v-4h-2zm0 6v2h2v-2h-2z"/></svg>`;

    const statusIconOn = `<svg viewBox="0 0 24 24" width="16" height="16" fill="var(--c-yellow)"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`;
    const statusIconOff = `<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="var(--c-red)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="2" y1="2" x2="22" y2="22"></line><path d="M8.5 8.5L3 14h9l-1 8 5.5-5.5"></path><path d="M16 10h5l-1.5 1.5"></path><path d="M12.4 6.6L13 2l-2.6 2.6"></path></svg>`;

    let globalIntervals = [];
    let emergencyData = null;
    let initialScrollDone = false;

    function timeToMins(t) {
        if (!t) return null;
        let [h, m] = t.split(':').map(Number);
        return h * 60 + m;
    }

    async function fetchData() {
        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`);
            const result = await response.json();
            const data = result.record;

            document.getElementById('dateDisplay').textContent = data.date;
            globalIntervals = data.intervals || [];
            emergencyData = data.emergency || { active: false };

            document.getElementById('loader').style.display = 'none';
            document.getElementById('app').style.display = 'block';

            startTimerAndRender();
        } catch (error) {
            document.getElementById('loader').textContent = "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π –ø—ñ–∑–Ω—ñ—à–µ.";
        }
    }

    function buildDisplayIntervals() {
        if (!emergencyData || !emergencyData.active) {
            return globalIntervals;
        }

        const emStart = timeToMins(emergencyData.start);
        const emEnd = emergencyData.end ? timeToMins(emergencyData.end) : 1440;

        let result = [];

        globalIntervals.forEach(int => {
            if (int.endMin <= emStart || int.startMin >= emEnd) {
                result.push(int);
                return;
            }
            if (int.startMin < emStart) {
                result.push({ ...int, endMin: emStart, displayEndStr: emergencyData.start });
            }
            if (int.endMin > emEnd) {
                result.push({ ...int, startMin: emEnd, startStr: emergencyData.end });
            }
        });

        result.push({
            startMin: emStart,
            endMin: emEnd,
            startStr: emergencyData.start,
            displayEndStr: emergencyData.end || "??:??",
            type: 'off',
            isEmergencyBlock: true
        });

        result.sort((a, b) => a.startMin - b.startMin);
        return result;
    }

    function renderTimeline(currentMins) {
        const container = document.getElementById('timelineContainer');

        if (globalIntervals.length === 0) {
            container.innerHTML = `<div class="waiting-block">‚è≥ –û—á—ñ–∫—É—î–º–æ –Ω–∞ –≥—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥ –û–±–ª–µ–Ω–µ—Ä–≥–æ</div>`;
            return;
        }

        const displayIntervals = buildDisplayIntervals();
        let html = '';

        displayIntervals.forEach((int, i) => {
            const isEmergency = int.isEmergencyBlock;
            const isVisuallyOn = int.type === 'on' && !isEmergency;
            const stateClass = isEmergency ? 'emergency' : (isVisuallyOn ? 'on' : 'off');

            const isActive = (currentMins >= int.startMin && currentMins < int.endMin);
            const isPast = (currentMins >= int.endMin);
            const isFuture = (currentMins < int.startMin);

            let classes = `tl-item ${stateClass}`;
            if (isActive) {
                classes += ' active-now';
                if (isEmergency) classes += ' emergency-active';
            }
            if (isPast) classes += ' past-interval';

            let badgeHtml = '';
            let intervalTextStyle = '';

            if (isEmergency) {
                badgeHtml = `<div class="badge emergency">${iconWarning} –ê–í–ê–†–Ü–ô–ù–ï</div>`;
            } else if (int.type === 'off') {
                if (int.isModified) {
                    let statusText = isPast ? "üí° –°–í–Ü–¢–õ–û –ë–£–õ–û" : (isActive ? "üí° –Ñ –°–í–Ü–¢–õ–û" : "üí° –°–ö–ê–°–û–í–ê–ù–û");
                    badgeHtml = `<div class="badge-row"><div class="badge off" style="text-decoration: line-through; opacity: 0.5;">${iconBan} –í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø</div><span class="badge-modifier rescued">${statusText}</span></div>`;
                    intervalTextStyle = `color: rgba(251, 191, 36, 0.7); text-decoration: line-through;`;
                } else {
                    badgeHtml = `<div class="badge off"><span style="color:var(--c-red); display:flex;">${iconBan}</span> –í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø</div>`;
                }
            } else {
                let lightText = isFuture ? "–°–í–Ü–¢–õ–û" : "–°–í–Ü–¢–õ–û –Ñ";
                badgeHtml = `<div class="badge on">${iconLightningSVG} ${lightText}</div>`;
            }

            const intIcon = isEmergency ? iconZapOff : (isVisuallyOn ? iconBulb : iconZapOff);

            let dotsHtml = '';
            if (i < displayIntervals.length - 1) {
                let durationMins = int.endMin - int.startMin;
                let fullDots = Math.floor(durationMins / 60);
                for (let d = 0; d < fullDots; d++) {
                    dotsHtml += `<div class="tl-dot-micro ${stateClass}"></div>`;
                }
            }

            const timeColClass = isEmergency ? 'emergency' : stateClass;

            html += `
            <div class="${classes}">
                <div class="tl-head">
                    <div class="time-col ${timeColClass}">${int.startStr}</div>
                    <div class="icon-node"><div class="icon-circle">${houseSvg}</div></div>
                    <div class="badge-col">${badgeHtml}</div>
                </div>
                <div class="tl-body">
                    <div class="time-col"></div>
                    <div class="line-node">${dotsHtml}</div>
                    <div class="interval-col">
                        <div class="interval ${stateClass}">
                            <div class="interval-icon">${intIcon}</div>
                            <span class="interval-text" style="${intervalTextStyle}">${int.startStr} ‚Äì ${int.displayEndStr}</span>
                        </div>
                    </div>
                </div>
            </div>`;
        });

        const lastInt = displayIntervals[displayIntervals.length - 1];
        if (lastInt && lastInt.endMin < 1440) {
            html += `<div class="waiting-block">–û—á—ñ–∫—É—î–º–æ –≥—Ä–∞—Ñ—ñ–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞...</div>`;
        }

        container.innerHTML = html;

        if (!initialScrollDone) {
            setTimeout(() => {
                const activeEl = document.querySelector('.active-now');
                if (activeEl) activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                initialScrollDone = true;
            }, 300);
        }
    }

    function startTimerAndRender() {
        let lastRenderedIntervalIndex = -1;

        setInterval(() => {
            const now = new Date();
            const currentMins = now.getHours() * 60 + now.getMinutes();
            const currentSecs = now.getSeconds();

            const emActive = emergencyData && emergencyData.active;
            const emStart = emActive ? timeToMins(emergencyData.start) : null;
            const emEnd = emActive && emergencyData.end ? timeToMins(emergencyData.end) : null;

            let currentIntIndex = -1;
            let currentState = null;
            let nextEventMins = null;

            const getRealState = (int) => {
                if (int.type === 'off' && !int.isModified) return 'off';
                if (int.type === 'on' && int.isModified) return 'off';
                return 'on';
            };

            for (let i = 0; i < globalIntervals.length; i++) {
                let int = globalIntervals[i];
                if (currentMins >= int.startMin && currentMins < int.endMin) {
                    currentIntIndex = i;
                    currentState = getRealState(int);
                    break;
                }
            }

            if (emActive && emStart !== null && currentMins >= emStart && (emEnd === null || currentMins < emEnd)) {
                currentState = 'off';
                nextEventMins = emEnd;
            } else if (!emActive && currentIntIndex !== -1) {
                for (let i = currentIntIndex + 1; i < globalIntervals.length; i++) {
                    let nextInt = globalIntervals[i];
                    if (getRealState(nextInt) !== currentState) {
                        nextEventMins = nextInt.startMin;
                        break;
                    }
                }
            }

            if (currentIntIndex !== lastRenderedIntervalIndex || lastRenderedIntervalIndex === -1) {
                renderTimeline(currentMins);
                lastRenderedIntervalIndex = currentIntIndex;
            }

            const timerDisplay = document.getElementById('timerDisplay');
            const timerLabel = document.getElementById('timerLabel');
            const timerStatus = document.getElementById('timerStatus');

            if (globalIntervals.length === 0) {
                timerDisplay.textContent = "--:--:--";
                timerLabel.textContent = "–û—á—ñ–∫—É–≤–∞–Ω–Ω—è";
                timerStatus.innerHTML = `${iconBulb} –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö`;
                timerStatus.style.color = '#888';
                return;
            }

            if (nextEventMins !== null) {
                let diffMins = nextEventMins - currentMins - 1;
                let diffSecs = 60 - currentSecs;
                if (diffSecs === 60) { diffSecs = 0; diffMins++; }

                let h = Math.floor(diffMins / 60).toString().padStart(2, '0');
                let m = (diffMins % 60).toString().padStart(2, '0');
                let s = diffSecs.toString().padStart(2, '0');

                timerDisplay.textContent = `${h}:${m}:${s}`;

                if (currentState === 'off') {
                    timerDisplay.className = 'timer-time off';
                    timerLabel.textContent = '–î–æ –≤–∫–ª—é—á–µ–Ω–Ω—è:';
                    timerStatus.innerHTML = `${statusIconOff} –°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞—î`;
                    timerStatus.style.color = 'var(--c-red)';
                } else {
                    timerDisplay.className = 'timer-time on';
                    timerLabel.textContent = '–î–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:';
                    timerStatus.innerHTML = `${statusIconOn} –°–≤—ñ—Ç–ª–æ —î`;
                    timerStatus.style.color = 'var(--c-yellow)';
                }
            } else if (emActive) {
                timerDisplay.textContent = "--:--:--";
                timerDisplay.className = 'timer-time off';
                timerLabel.textContent = '–ê–≤–∞—Ä—ñ–π–Ω–∏–π —Ä–µ–∂–∏–º';
                timerStatus.innerHTML = `${statusIconOff} –°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞—î`;
                timerStatus.style.color = 'var(--c-red)';
            } else {
                timerDisplay.textContent = "00:00:00";
                timerDisplay.className = 'timer-time off';
                timerDisplay.style.color = '#555';
                timerDisplay.style.textShadow = 'none';
                timerLabel.textContent = "–û–ß–Ü–ö–£–Ñ–ú–û –ì–†–ê–§–Ü–ö";
                timerStatus.innerHTML = `<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö`;
                timerStatus.style.color = '#555';
            }

        }, 1000);
    }

    fetchData();
</script>

</body>
</html>
